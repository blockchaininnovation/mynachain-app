import React, { useState, useEffect } from 'react';
import { Button, Container, TextField } from '@material-ui/core';
import { useApi } from './Api';
import { makeStyles } from '@material-ui/core/styles';
import { Keyring } from '@polkadot/api';

const keyring = new Keyring({ type: 'sr25519' });
const useStyles = makeStyles({
  root: {
    "& > *": {
      margin: "10px"
    }
  }
})

export default function NewAccount() {
  const { api } = useApi();
  const { root } = useStyles();

  const useHexInput = (initial: string) => {
    const [value, set] = useState(initial);
    let isHex = /^0x([a-fA-F0-9]{2})*$/.test(value);

    return { value, onChange: (e: any) => set(e.target.value), error: !isHex }
  }
  const cert = useHexInput(CERT);
  const sig = useHexInput(SIG);
  const [log, setLog] = useState("");
  const [hash, setHash] = useState("");
  const getHash = () => {
    setLog("")
    try {
      const submittable: any = api.tx.mynaChainModule.go({
        signature: "0x00",
        id: 0,
        tbs: {
          CreateAccount: {
            cert: cert.value,
            nonce: 0
          }
        }
      });
      setHash(submittable.args[0]["tbs"].hash.toHex())
    } catch (e) {
      setLog(e.toString());
    }
  }
  const send = () => {
    setLog("")
    try {
      const submittable = api.tx.mynaChainModule.go({
        signature: sig.value,
        id: 0,
        tbs: {
          CreateAccount: {
            cert: cert.value,
            nonce: 0
          }
        }
      });
      setHash("")
      const alice = keyring.addFromUri('//Alice', { name: 'Alice default' });
      submittable.signAndSend(alice, (e) => {
        console.log(e);
        if (e.events.length == 0) return;
        e.events.forEach((m: any) => {
          const msg = m.event.meta.name.toString();
          setLog(msg);
        });
      })
    } catch (e) {
      setLog(e.toString());
    }
  }
  return (
    <Container maxWidth="sm" className={root}>
      <TextField
        label="証明書"
        fullWidth={true}
        placeholder="0x......"
        multiline
        {...cert}
      />
      <Button
        variant="contained"
        color="primary"
        fullWidth={true}
        onClick={getHash}
        disabled={cert.error}
      >カードに渡すハッシュ値を作成</Button>
      <TextField

        label="カードに渡すハッシュ値"
        fullWidth={true}
        placeholder="0x......"
        multiline
        value={hash}
      />

      <TextField

        label="署名"
        fullWidth={true}
        placeholder="0x......"
        multiline
        {...sig}
      />
      <Button
        variant="contained"
        color="primary"
        fullWidth={true}
        onClick={send}
        disabled={sig.error}
      >トランザクション送信</Button>
      <TextField
        label="ログ"
        fullWidth={true}
        multiline
        disabled
        value={log}
      />
    </Container>
  )
}

const CERT = "0x" + Buffer.from([48, 130, 6, 33, 48, 130, 5, 9, 160, 3, 2, 1, 2, 2, 4, 1, 45, 87, 202, 48, 13, 6, 9, 42, 134, 72, 134, 247, 13, 1, 1, 11, 5, 0, 48, 129, 130, 49, 11, 48, 9, 6, 3, 85, 4, 6, 19, 2, 74, 80, 49, 13, 48, 11, 6, 3, 85, 4, 10, 12, 4, 74, 80, 75, 73, 49, 37, 48, 35, 6, 3, 85, 4, 11, 12, 28, 74, 80, 75, 73, 32, 102, 111, 114, 32, 117, 115, 101, 114, 32, 97, 117, 116, 104, 101, 110, 116, 105, 99, 97, 116, 105, 111, 110, 49, 61, 48, 59, 6, 3, 85, 4, 11, 12, 52, 74, 97, 112, 97, 110, 32, 65, 103, 101, 110, 99, 121, 32, 102, 111, 114, 32, 76, 111, 99, 97, 108, 32, 65, 117, 116, 104, 111, 114, 105, 116, 121, 32, 73, 110, 102, 111, 114, 109, 97, 116, 105, 111, 110, 32, 83, 121, 115, 116, 101, 109, 115, 48, 30, 23, 13, 49, 57, 48, 55, 50, 53, 49, 53, 50, 56, 48, 54, 90, 23, 13, 50, 52, 48, 53, 48, 50, 49, 52, 53, 57, 53, 57, 90, 48, 47, 49, 11, 48, 9, 6, 3, 85, 4, 6, 19, 2, 74, 80, 49, 32, 48, 30, 6, 3, 85, 4, 3, 12, 23, 56, 52, 48, 52, 52, 52, 69, 51, 55, 80, 65, 70, 72, 78, 48, 56, 50, 50, 48, 48, 48, 51, 65, 48, 130, 1, 34, 48, 13, 6, 9, 42, 134, 72, 134, 247, 13, 1, 1, 1, 5, 0, 3, 130, 1, 15, 0, 48, 130, 1, 10, 2, 130, 1, 1, 0, 194, 228, 140, 69, 192, 115, 99, 226, 70, 190, 68, 64, 124, 138, 245, 49, 124, 188, 205, 58, 168, 190, 93, 38, 18, 146, 36, 82, 90, 201, 253, 115, 188, 101, 41, 97, 2, 212, 135, 68, 96, 9, 82, 240, 73, 60, 57, 118, 87, 201, 102, 226, 86, 79, 249, 239, 81, 117, 53, 126, 236, 150, 40, 3, 96, 150, 50, 97, 7, 169, 11, 213, 56, 246, 115, 144, 170, 236, 188, 216, 86, 114, 189, 198, 111, 8, 139, 63, 31, 160, 101, 112, 9, 193, 70, 219, 236, 56, 17, 28, 80, 117, 115, 88, 227, 1, 104, 3, 207, 94, 206, 102, 89, 39, 179, 119, 175, 223, 5, 132, 50, 166, 36, 179, 114, 210, 227, 156, 245, 52, 171, 158, 212, 73, 218, 18, 186, 35, 159, 224, 221, 150, 246, 92, 114, 204, 234, 107, 107, 253, 151, 51, 196, 30, 144, 237, 238, 31, 132, 32, 120, 172, 92, 222, 124, 149, 198, 36, 42, 50, 37, 22, 239, 34, 146, 127, 53, 171, 184, 175, 232, 50, 118, 51, 215, 222, 208, 149, 147, 132, 210, 5, 133, 59, 132, 114, 111, 171, 237, 41, 24, 47, 2, 19, 182, 167, 79, 17, 134, 81, 210, 196, 196, 21, 184, 37, 61, 58, 194, 211, 57, 200, 119, 83, 97, 182, 32, 24, 73, 254, 153, 98, 111, 89, 31, 85, 140, 92, 145, 106, 121, 24, 44, 133, 107, 177, 89, 154, 209, 43, 229, 211, 55, 72, 231, 153, 2, 3, 1, 0, 1, 163, 130, 2, 239, 48, 130, 2, 235, 48, 14, 6, 3, 85, 29, 15, 1, 1, 255, 4, 4, 3, 2, 7, 128, 48, 19, 6, 3, 85, 29, 37, 4, 12, 48, 10, 6, 8, 43, 6, 1, 5, 5, 7, 3, 2, 48, 73, 6, 3, 85, 29, 32, 1, 1, 255, 4, 63, 48, 61, 48, 59, 6, 11, 42, 131, 8, 140, 155, 85, 8, 5, 1, 3, 30, 48, 44, 48, 42, 6, 8, 43, 6, 1, 5, 5, 7, 2, 1, 22, 30, 104, 116, 116, 112, 58, 47, 47, 119, 119, 119, 46, 106, 112, 107, 105, 46, 103, 111, 46, 106, 112, 47, 99, 112, 115, 46, 104, 116, 109, 108, 48, 129, 183, 6, 3, 85, 29, 18, 4, 129, 175, 48, 129, 172, 164, 129, 169, 48, 129, 166, 49, 11, 48, 9, 6, 3, 85, 4, 6, 19, 2, 74, 80, 49, 39, 48, 37, 6, 3, 85, 4, 10, 12, 30, 229, 133, 172, 231, 154, 132, 229, 128, 139, 228, 186, 186, 232, 170, 141, 232, 168, 188, 227, 130, 181, 227, 131, 188, 227, 131, 147, 227, 130, 185, 49, 57, 48, 55, 6, 3, 85, 4, 11, 12, 48, 229, 133, 172, 231, 154, 132, 229, 128, 139, 228, 186, 186, 232, 170, 141, 232, 168, 188, 227, 130, 181, 227, 131, 188, 227, 131, 147, 227, 130, 185, 229, 136, 169, 231, 148, 168, 232, 128, 133, 232, 168, 188, 230, 152, 142, 231, 148, 168, 49, 51, 48, 49, 6, 3, 85, 4, 11, 12, 42, 229, 156, 176, 230, 150, 185, 229, 133, 172, 229, 133, 177, 229, 155, 163, 228, 189, 147, 230, 131, 133, 229, 160, 177, 227, 130, 183, 227, 130, 185, 227, 131, 134, 227, 131, 160, 230, 169, 159, 230, 167, 139, 48, 129, 177, 6, 3, 85, 29, 31, 4, 129, 169, 48, 129, 166, 48, 129, 163, 160, 129, 160, 160, 129, 157, 164, 129, 154, 48, 129, 151, 49, 11, 48, 9, 6, 3, 85, 4, 6, 19, 2, 74, 80, 49, 13, 48, 11, 6, 3, 85, 4, 10, 12, 4, 74, 80, 75, 73, 49, 37, 48, 35, 6, 3, 85, 4, 11, 12, 28, 74, 80, 75, 73, 32, 102, 111, 114, 32, 117, 115, 101, 114, 32, 97, 117, 116, 104, 101, 110, 116, 105, 99, 97, 116, 105, 111, 110, 49, 32, 48, 30, 6, 3, 85, 4, 11, 12, 23, 67, 82, 76, 32, 68, 105, 115, 116, 114, 105, 98, 117, 116, 105, 111, 110, 32, 80, 111, 105, 110, 116, 115, 49, 20, 48, 18, 6, 3, 85, 4, 11, 12, 11, 73, 98, 97, 114, 97, 107, 105, 45, 107, 101, 110, 49, 26, 48, 24, 6, 3, 85, 4, 3, 12, 17, 84, 115, 117, 107, 117, 98, 97, 45, 115, 104, 105, 32, 67, 82, 76, 68, 80, 48, 58, 6, 8, 43, 6, 1, 5, 5, 7, 1, 1, 4, 46, 48, 44, 48, 42, 6, 8, 43, 6, 1, 5, 5, 7, 48, 1, 134, 30, 104, 116, 116, 112, 58, 47, 47, 111, 99, 115, 112, 97, 117, 116, 104, 110, 111, 114, 109, 46, 106, 112, 107, 105, 46, 103, 111, 46, 106, 112, 48, 129, 175, 6, 3, 85, 29, 35, 4, 129, 167, 48, 129, 164, 128, 20, 149, 103, 149, 27, 92, 167, 13, 132, 160, 255, 241, 216, 90, 135, 241, 170, 177, 52, 3, 133, 161, 129, 136, 164, 129, 133, 48, 129, 130, 49, 11, 48, 9, 6, 3, 85, 4, 6, 19, 2, 74, 80, 49, 13, 48, 11, 6, 3, 85, 4, 10, 12, 4, 74, 80, 75, 73, 49, 37, 48, 35, 6, 3, 85, 4, 11, 12, 28, 74, 80, 75, 73, 32, 102, 111, 114, 32, 117, 115, 101, 114, 32, 97, 117, 116, 104, 101, 110, 116, 105, 99, 97, 116, 105, 111, 110, 49, 61, 48, 59, 6, 3, 85, 4, 11, 12, 52, 74, 97, 112, 97, 110, 32, 65, 103, 101, 110, 99, 121, 32, 102, 111, 114, 32, 76, 111, 99, 97, 108, 32, 65, 117, 116, 104, 111, 114, 105, 116, 121, 32, 73, 110, 102, 111, 114, 109, 97, 116, 105, 111, 110, 32, 83, 121, 115, 116, 101, 109, 115, 130, 1, 1, 48, 29, 6, 3, 85, 29, 14, 4, 22, 4, 20, 119, 246, 196, 215, 22, 216, 205, 226, 42, 39, 238, 211, 211, 175, 73, 110, 31, 176, 239, 245, 48, 13, 6, 9, 42, 134, 72, 134, 247, 13, 1, 1, 11, 5, 0, 3, 130, 1, 1, 0, 42, 221, 245, 188, 229, 66, 144, 12, 111, 147, 171, 60, 207, 206, 105, 75, 194, 15, 191, 148, 214, 9, 99, 66, 194, 23, 207, 241, 70, 88, 4, 127, 76, 30, 64, 219, 35, 104, 38, 120, 66, 8, 16, 147, 184, 10, 138, 28, 185, 208, 146, 94, 254, 17, 2, 64, 167, 17, 95, 185, 131, 30, 203, 181, 247, 14, 31, 163, 139, 185, 120, 66, 173, 104, 32, 79, 65, 26, 147, 138, 199, 251, 49, 107, 184, 109, 208, 227, 46, 162, 72, 215, 128, 191, 139, 244, 225, 48, 219, 241, 86, 163, 54, 237, 226, 192, 161, 165, 47, 76, 70, 242, 92, 89, 132, 57, 115, 193, 158, 145, 10, 17, 167, 43, 128, 42, 85, 254, 74, 152, 210, 2, 0, 63, 40, 122, 182, 47, 144, 187, 248, 63, 87, 124, 116, 164, 153, 86, 30, 224, 5, 173, 155, 237, 16, 86, 151, 122, 82, 154, 79, 60, 140, 211, 149, 163, 126, 127, 91, 60, 158, 127, 152, 193, 19, 160, 145, 171, 117, 82, 85, 137, 233, 29, 197, 241, 82, 211, 90, 210, 9, 246, 192, 102, 192, 182, 155, 193, 25, 59, 146, 198, 235, 135, 129, 213, 204, 203, 195, 83, 246, 213, 33, 204, 55, 175, 60, 172, 96, 12, 97, 223, 103, 167, 17, 124, 141, 252, 91, 51, 68, 98, 118, 226, 204, 5, 21, 232, 89, 190, 161, 223, 211, 122, 164, 194, 56, 230, 101, 246, 85, 209, 177, 79, 95, 211]).toString("hex")

const SIG = ""
